#include "pieces.h"

#define PIECES_VIA_DEFINE
#ifdef PIECES_VIA_DEFINE

// I piece
#define I0 { \
	{BLANK, BLANK, BLANK, BLANK}, \
	{CYAN,  CYAN,  CYAN,  CYAN},  \
	{BLANK, BLANK, BLANK, BLANK}, \
	{BLANK, BLANK, BLANK, BLANK}  \
}
#define I1 { \
	{BLANK, BLANK, CYAN, BLANK}, \
	{BLANK, BLANK, CYAN, BLANK}, \
	{BLANK, BLANK, CYAN, BLANK}, \
	{BLANK, BLANK, CYAN, BLANK}  \
}

// T piece
#define T0 { \
	{BLANK,  BLANK,  BLANK,  BLANK}, \
	{PURPLE, PURPLE, PURPLE, BLANK}, \
	{BLANK,  PURPLE, BLANK,  BLANK}, \
	{BLANK,  BLANK,  BLANK,  BLANK}  \
}
#define T1 { \
	{BLANK,  PURPLE, BLANK, BLANK}, \
	{PURPLE, PURPLE, BLANK, BLANK}, \
	{BLANK,  PURPLE, BLANK, BLANK}, \
	{BLANK,  BLANK,  BLANK, BLANK}  \
}
#define T2 { \
	{BLANK,  BLANK,  BLANK,  BLANK}, \
	{BLANK,  PURPLE, BLANK,  BLANK}, \
	{PURPLE, PURPLE, PURPLE, BLANK}, \
	{BLANK,  BLANK,  BLANK,  BLANK}  \
}
#define T3 { \
	{BLANK, PURPLE, BLANK,  BLANK}, \
	{BLANK, PURPLE, PURPLE, BLANK}, \
	{BLANK, PURPLE, BLANK,  BLANK}, \
	{BLANK, BLANK,  BLANK,  BLANK}  \
}

// L piece
#define L0 { \
	{BLANK,  BLANK,  BLANK,  BLANK}, \
	{ORANGE, ORANGE, ORANGE, BLANK}, \
	{ORANGE, BLANK,  BLANK,  BLANK}, \
	{BLANK,  BLANK,  BLANK,  BLANK}  \
}
#define L1 { \
	{ORANGE, ORANGE, BLANK, BLANK}, \
	{BLANK,  ORANGE, BLANK, BLANK}, \
	{BLANK,  ORANGE, BLANK, BLANK}, \
	{BLANK,  BLANK,  BLANK, BLANK}  \
}
#define L2 { \
	{BLANK,  BLANK,  BLANK,  BLANK}, \
	{BLANK,  BLANK,  ORANGE, BLANK}, \
	{ORANGE, ORANGE, ORANGE, BLANK}, \
	{BLANK,  BLANK,  BLANK,  BLANK}  \
}
#define L3 { \
	{BLANK, ORANGE, BLANK,  BLANK}, \
	{BLANK, ORANGE, BLANK,  BLANK}, \
	{BLANK, ORANGE, ORANGE, BLANK}, \
	{BLANK, BLANK,  BLANK,  BLANK}  \
}

// J piece
#define J0 { \
	{BLANK,  BLANK, BLANK, BLANK}, \
	{BLUE,   BLUE,  BLUE,  BLANK}, \
	{BLANK,  BLANK, BLUE,  BLANK}, \
	{BLANK,  BLANK, BLANK, BLANK}  \
}
#define J1 { \
	{BLANK, BLUE,  BLANK, BLANK}, \
	{BLANK, BLUE,  BLANK, BLANK}, \
	{BLUE,  BLUE,  BLANK, BLANK}, \
	{BLANK, BLANK, BLANK, BLANK}  \
}
#define J2 { \
	{BLANK, BLANK, BLANK, BLANK}, \
	{BLUE,  BLANK, BLANK, BLANK}, \
	{BLUE,  BLUE,  BLUE,  BLANK}, \
	{BLANK, BLANK, BLANK, BLANK}  \
}
#define J3 { \
	{BLANK, BLUE,  BLUE,  BLANK}, \
	{BLANK, BLUE,  BLANK, BLANK}, \
	{BLANK, BLUE,  BLANK, BLANK}, \
	{BLANK, BLANK, BLANK, BLANK}  \
}

// S piece
#define S0 { \
	{BLANK, BLANK, BLANK, BLANK}, \
	{BLANK, GREEN, GREEN, BLANK}, \
	{GREEN, GREEN, BLANK, BLANK}, \
	{BLANK, BLANK, BLANK, BLANK}  \
}
#define S1 { \
	{GREEN, BLANK, BLANK, BLANK}, \
	{GREEN, GREEN, BLANK, BLANK}, \
	{BLANK, GREEN, BLANK, BLANK}, \
	{BLANK, BLANK, BLANK, BLANK}  \
}

// Z piece
#define Z0 { \
	{BLANK, BLANK, BLANK, BLANK}, \
	{RED,   RED,   BLANK, BLANK}, \
	{BLANK, RED,   RED,   BLANK}, \
	{BLANK, BLANK, BLANK, BLANK}  \
}
#define Z1 { \
	{BLANK, BLANK, RED,   BLANK}, \
	{BLANK, RED,   RED,   BLANK}, \
	{BLANK, RED,   BLANK, BLANK}, \
	{BLANK, BLANK, BLANK, BLANK}  \
}

// O piece
#define O { \
	{BLANK, BLANK,  BLANK,  BLANK}, \
	{BLANK, YELLOW, YELLOW, BLANK}, \
	{BLANK, YELLOW, YELLOW, BLANK}, \
	{BLANK, BLANK,  BLANK,  BLANK}  \
}

const uint8_t PieceColormaps[7][4][4][4] = {
	{L0, L1, L2, L3}, // L
	{J0, J1, J2, J3}, // J
	{T0, T1, T2, T3}, // T
	{Z0, Z1, Z0, Z1}, // Z
	{O,  O,  O,  O},  // O
	{S0, S1, S0, S1}, // S
	{I0, I1, I0, I1}, // I
};
#else
const uint8_t PieceColormaps[7][4][4][4] = {
    // L
    {{{BLANK, BLANK, BLANK, BLANK},
      {ORANGE, ORANGE, ORANGE, BLANK},
      {ORANGE, BLANK, BLANK, BLANK},
      {BLANK, BLANK, BLANK, BLANK}},
     {{ORANGE, ORANGE, BLANK, BLANK},
      {BLANK, ORANGE, BLANK, BLANK},
      {BLANK, ORANGE, BLANK, BLANK},
      {BLANK, BLANK, BLANK, BLANK}},
     {{BLANK, BLANK, BLANK, BLANK},
      {BLANK, BLANK, ORANGE, BLANK},
      {ORANGE, ORANGE, ORANGE, BLANK},
      {BLANK, BLANK, BLANK, BLANK}},
     {{BLANK, ORANGE, BLANK, BLANK},
      {BLANK, ORANGE, BLANK, BLANK},
      {BLANK, ORANGE, ORANGE, BLANK},
      {BLANK, BLANK, BLANK, BLANK}}},
    // J
    {{{BLANK, BLANK, BLANK, BLANK},
      {BLUE, BLUE, BLUE, BLANK},
      {BLANK, BLANK, BLUE, BLANK},
      {BLANK, BLANK, BLANK, BLANK}},
     {{BLANK, BLUE, BLANK, BLANK},
      {BLANK, BLUE, BLANK, BLANK},
      {BLUE, BLUE, BLANK, BLANK},
      {BLANK, BLANK, BLANK, BLANK}},
     {{BLANK, BLANK, BLANK, BLANK},
      {BLUE, BLANK, BLANK, BLANK},
      {BLUE, BLUE, BLUE, BLANK},
      {BLANK, BLANK, BLANK, BLANK}},
     {{BLANK, BLUE, BLUE, BLANK},
      {BLANK, BLUE, BLANK, BLANK},
      {BLANK, BLUE, BLANK, BLANK},
      {BLANK, BLANK, BLANK, BLANK}}},
    // T
    {{{BLANK, BLANK, BLANK, BLANK},
      {PURPLE, PURPLE, PURPLE, BLANK},
      {BLANK, PURPLE, BLANK, BLANK},
      {BLANK, BLANK, BLANK, BLANK}},
     {{BLANK, PURPLE, BLANK, BLANK},
      {PURPLE, PURPLE, BLANK, BLANK},
      {BLANK, PURPLE, BLANK, BLANK},
      {BLANK, BLANK, BLANK, BLANK}},
     {{BLANK, BLANK, BLANK, BLANK},
      {BLANK, PURPLE, BLANK, BLANK},
      {PURPLE, PURPLE, PURPLE, BLANK},
      {BLANK, BLANK, BLANK, BLANK}},
     {{BLANK, PURPLE, BLANK, BLANK},
      {BLANK, PURPLE, PURPLE, BLANK},
      {BLANK, PURPLE, BLANK, BLANK},
      {BLANK, BLANK, BLANK, BLANK}}},
    // Z
    {{{BLANK, BLANK, BLANK, BLANK},
      {RED, RED, BLANK, BLANK},
      {BLANK, RED, RED, BLANK},
      {BLANK, BLANK, BLANK, BLANK}},
     {{BLANK, BLANK, RED, BLANK},
      {BLANK, RED, RED, BLANK},
      {BLANK, RED, BLANK, BLANK},
      {BLANK, BLANK, BLANK, BLANK}},
     {{BLANK, BLANK, BLANK, BLANK},
      {RED, RED, BLANK, BLANK},
      {BLANK, RED, RED, BLANK},
      {BLANK, BLANK, BLANK, BLANK}},
     {{BLANK, BLANK, RED, BLANK},
      {BLANK, RED, RED, BLANK},
      {BLANK, RED, BLANK, BLANK},
      {BLANK, BLANK, BLANK, BLANK}}},
    // O
    {{{BLANK, BLANK, BLANK, BLANK},
      {BLANK, YELLOW, YELLOW, BLANK},
      {BLANK, YELLOW, YELLOW, BLANK},
      {BLANK, BLANK, BLANK, BLANK}},
     {{BLANK, BLANK, BLANK, BLANK},
      {BLANK, YELLOW, YELLOW, BLANK},
      {BLANK, YELLOW, YELLOW, BLANK},
      {BLANK, BLANK, BLANK, BLANK}},
     {{BLANK, BLANK, BLANK, BLANK},
      {BLANK, YELLOW, YELLOW, BLANK},
      {BLANK, YELLOW, YELLOW, BLANK},
      {BLANK, BLANK, BLANK, BLANK}},
     {{BLANK, BLANK, BLANK, BLANK},
      {BLANK, YELLOW, YELLOW, BLANK},
      {BLANK, YELLOW, YELLOW, BLANK},
      {BLANK, BLANK, BLANK, BLANK}}},
    // S
    {{{BLANK, BLANK, BLANK, BLANK},
      {BLANK, GREEN, GREEN, BLANK},
      {GREEN, GREEN, BLANK, BLANK},
      {BLANK, BLANK, BLANK, BLANK}},
     {{GREEN, BLANK, BLANK, BLANK},
      {GREEN, GREEN, BLANK, BLANK},
      {BLANK, GREEN, BLANK, BLANK},
      {BLANK, BLANK, BLANK, BLANK}},
     {{BLANK, BLANK, BLANK, BLANK},
      {BLANK, GREEN, GREEN, BLANK},
      {GREEN, GREEN, BLANK, BLANK},
      {BLANK, BLANK, BLANK, BLANK}},
     {{GREEN, BLANK, BLANK, BLANK},
      {GREEN, GREEN, BLANK, BLANK},
      {BLANK, GREEN, BLANK, BLANK},
      {BLANK, BLANK, BLANK, BLANK}}},
    // I
    {{{BLANK, BLANK, BLANK, BLANK},
      {CYAN, CYAN, CYAN, CYAN},
      {BLANK, BLANK, BLANK, BLANK},
      {BLANK, BLANK, BLANK, BLANK}},
     {{BLANK, BLANK, CYAN, BLANK},
      {BLANK, BLANK, CYAN, BLANK},
      {BLANK, BLANK, CYAN, BLANK},
      {BLANK, BLANK, CYAN, BLANK}},
     {{BLANK, BLANK, BLANK, BLANK},
      {CYAN, CYAN, CYAN, CYAN},
      {BLANK, BLANK, BLANK, BLANK},
      {BLANK, BLANK, BLANK, BLANK}},
     {{BLANK, BLANK, CYAN, BLANK},
      {BLANK, BLANK, CYAN, BLANK},
      {BLANK, BLANK, CYAN, BLANK},
      {BLANK, BLANK, CYAN, BLANK}}},
};
#endif // screw this compiler





#define IMAGES_VIA_DEFINE
#ifdef IMAGES_VIA_DEFINE

#define garbageBlock { \
 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, \
 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, \
 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, \
 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, 0xC618, \
}
#define purpleBlock { \
 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, \
 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, \
 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, \
 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, 0xA254, \
}
#define yellowBlock { \
 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, \
 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, \
 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, \
 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, 0xFE49, \
}
#define orangeBlock { \
 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, \
 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, \
 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, \
 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, 0xFC20, \
}
#define cyanBlock	{ \
 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, \
 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, \
 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, \
 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, 0x079F, \
}
#define redBlock { \
 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, \
 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, \
 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, \
 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, 0xCA47, \
}
#define greenBlock { \
 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, \
 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, \
 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, \
 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, 0x4D84, \
}
#define blueBlock { \
 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, \
 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, \
 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, \
 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, 0x20FD, \
}
#define clearBlock { \
 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, \
 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, \
 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, \
 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, \
}

const uint16_t SquareBitmaps[9][64] = {
	clearBlock,
	redBlock,
	orangeBlock,
	yellowBlock,
	greenBlock,
	blueBlock,
	cyanBlock,
	purpleBlock,
	garbageBlock
};

#endif

#define BagRandomizer 0
uint32_t Random32(uint8_t gen);

static piece_t bag[] = {P_L, P_J, P_T, P_Z, P_O, P_S, P_I};

void RandomizeBag() {
	// bag = {P_L, P_J, P_T, P_Z, P_O, P_S, P_I};
	for(uint8_t i = 0, j, temp; i < 7; i++) {
		j = Random32(BagRandomizer) % (7 - i);
		
		temp = bag[i];
		bag[i] = bag[j];
		bag[j] = temp;
	}
}


// PIECE QUEUE
static piece_t queue[16];
static uint8_t start, end;

static void AddRandBag() {
	RandomizeBag();
	for(uint8_t i = 0; i < 7; ++i) {
		queue[end] = bag[i];
		end = (end + 1) & 0xF;
	}
}

// init piece queue
void PQ_Init() {
	start = end = 0;
	AddRandBag();
}
// get a piece
piece_t PQ_PollPiece() {
	piece_t output = queue[start];
	start = (start + 1) & 0xF;
	if(((start + PIECE_PREVIEWS) & 0xF) > end) AddRandBag();
	
	return output;
}
// get a piece preview
piece_t PQ_Preview(uint8_t index) {
	return queue[(start + index) & 0xF];
}
